name: Post Release (Reusable)

on:
  workflow_call:
    inputs:
      version_file_path:
        description: 'Path to the version file (e.g., lib/alchemy/solidus/version.rb)'
        required: true
        type: string
      target_branch:
        description: 'Branch to update (defaults to main)'
        required: false
        type: string
        default: 'main'
      gem_name:
        description: 'Name of the gem for announcements (defaults to repo name)'
        required: false
        type: string
    secrets:
      app_id:
        description: 'GitHub App ID for authentication'
        required: true
      app_private_key:
        description: 'GitHub App private key for authentication'
        required: true
      slack_webhook_url:
        description: 'Slack incoming webhook URL for release announcements'
        required: false
      mastodon_access_token:
        description: 'Mastodon bot access token'
        required: false
      mastodon_instance:
        description: 'Mastodon instance URL (e.g., https://ruby.social)'
        required: false
      bluesky_identifier:
        description: 'Bluesky handle or DID'
        required: false
      bluesky_password:
        description: 'Bluesky app password'
        required: false

jobs:
  bump-dev-version:
    runs-on: ubuntu-latest

    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          ref: ${{ inputs.target_branch }}

      - name: Calculate next dev version
        id: version
        run: |
          # Read current version
          CURRENT=$(grep VERSION "${{ inputs.version_file_path }}" | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT"

          # Strip any pre-release suffix to get base version
          BASE_VERSION=$(echo "$CURRENT" | sed 's/\.[a-zA-Z][a-zA-Z0-9]*$//')
          echo "Base version: $BASE_VERSION"

          # Split into major.minor.patch
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

          # Determine bump type based on branch
          # Stable branches (x.y-stable) bump PATCH, main bumps MINOR
          BRANCH="${{ inputs.target_branch }}"
          if [[ "$BRANCH" == *-stable ]]; then
            echo "Stable branch detected, bumping PATCH"
            PATCH=$((PATCH + 1))
            NEW_VERSION="$MAJOR.$MINOR.$PATCH.dev"
          else
            echo "Main branch detected, bumping MINOR"
            MINOR=$((MINOR + 1))
            NEW_VERSION="$MAJOR.$MINOR.0.dev"
          fi

          echo "New dev version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure git
        run: |
          git config user.name "alchemycms-bot"
          git config user.email "alchemycms-bot@users.noreply.github.com"

      - name: Bump to dev version
        run: |
          sed -i 's/VERSION = "[^"]*"/VERSION = "${{ steps.version.outputs.version }}"/' ${{ inputs.version_file_path }}

      - name: Create branch and push
        run: |
          BRANCH="post-release/${{ steps.version.outputs.version }}"
          git checkout -b "$BRANCH"
          git add ${{ inputs.version_file_path }}
          git commit -m "Start development of version ${{ steps.version.outputs.version }}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Start development of version ${{ steps.version.outputs.version }}',
              head: 'post-release/${{ steps.version.outputs.version }}',
              base: '${{ inputs.target_branch }}',
              body: 'Automated version bump after release.\n\nThis PR was automatically created by the post-release workflow.'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['skip-changelog']
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

  sync-changelog-to-main:
    if: ${{ inputs.target_branch != 'main' && contains(inputs.target_branch, '-stable') }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: Get released version
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog entry from stable branch
        id: changelog
        run: |
          # Extract the changelog section for this version
          # Matches from "## X.Y.Z" until the next "## " or end of file
          VERSION="${{ steps.version.outputs.version }}"

          # Use awk to extract the section
          awk -v ver="$VERSION" '
            /^## / {
              if (found) exit
              if (index($0, ver)) found=1
            }
            found { print }
          ' CHANGELOG.md > /tmp/changelog-entry.md

          echo "Extracted changelog entry:"
          cat /tmp/changelog-entry.md

      - name: Configure git
        run: |
          git config user.name "alchemycms-bot"
          git config user.email "alchemycms-bot@users.noreply.github.com"

      - name: Update changelog on main
        id: update-changelog
        run: |
          # Fetch and checkout main
          git fetch origin main
          git checkout main

          VERSION="${{ steps.version.outputs.version }}"

          # Check if this version already exists in main's changelog
          if grep -q "^## $VERSION" CHANGELOG.md; then
            echo "Version $VERSION already in main changelog, skipping"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Insert the changelog entry after the first line (# Changelog header)
          # and any blank lines following it
          {
            head -n 1 CHANGELOG.md
            echo ""
            cat /tmp/changelog-entry.md
            tail -n +2 CHANGELOG.md
          } > /tmp/changelog-new.md
          mv /tmp/changelog-new.md CHANGELOG.md

          # Create branch and commit
          BRANCH="changelog/$VERSION"
          git checkout -b "$BRANCH"
          git add CHANGELOG.md
          git commit -m "Add $VERSION changelog entry from stable branch"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"

      - name: Create Pull Request
        if: steps.update-changelog.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Add ${{ steps.version.outputs.version }} changelog entry from stable branch',
              head: '${{ steps.update-changelog.outputs.branch }}',
              base: 'main',
              body: 'Syncs changelog entry from stable branch release to main.\n\nThis ensures tools like Dependabot can see the changelog for this release.\n\nThis PR was automatically created by the post-release workflow.'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['skip-changelog']
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

  announce:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
      MASTODON_ACCESS_TOKEN: ${{ secrets.mastodon_access_token }}
      MASTODON_INSTANCE: ${{ secrets.mastodon_instance }}
      BLUESKY_IDENTIFIER: ${{ secrets.bluesky_identifier }}
      BLUESKY_PASSWORD: ${{ secrets.bluesky_password }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release version
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Post to Slack
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸŽ‰ *${{ inputs.gem_name || github.event.repository.name }} v${{ steps.version.outputs.version }}* has been released!\n\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}|View release notes>"
                  }
                }
              ]
            }

      - name: Post to Mastodon
        if: ${{ env.MASTODON_ACCESS_TOKEN != '' && env.MASTODON_INSTANCE != '' }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $MASTODON_ACCESS_TOKEN" \
            -F "status=ðŸŽ‰ ${{ inputs.gem_name || github.event.repository.name }} v${{ steps.version.outputs.version }} has been released!

          ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}

          #RubyGems #Ruby #Rails #CMS #AlchemyCMS" \
            "$MASTODON_INSTANCE/api/v1/statuses"

      - name: Post to Bluesky
        if: ${{ env.BLUESKY_IDENTIFIER != '' && env.BLUESKY_PASSWORD != '' }}
        uses: myConsciousness/bluesky-post@v5
        with:
          text: |
            ðŸŽ‰ ${{ inputs.gem_name || github.event.repository.name }} v${{ steps.version.outputs.version }} has been released!
          link-preview-url: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}
          tags: rubygems,ruby,rails,cms,alchemycms
          identifier: ${{ env.BLUESKY_IDENTIFIER }}
          password: ${{ env.BLUESKY_PASSWORD }}
