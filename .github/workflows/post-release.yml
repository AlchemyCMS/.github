name: Post Release (Reusable)

on:
  workflow_call:
    inputs:
      version_file_path:
        description: 'Path to the version file (e.g., lib/alchemy/solidus/version.rb)'
        required: true
        type: string
      target_branch:
        description: 'Branch to update (defaults to main)'
        required: false
        type: string
        default: 'main'
      gem_name:
        description: 'Name of the gem for announcements (defaults to repo name)'
        required: false
        type: string
    secrets:
      app_id:
        description: 'GitHub App ID for authentication'
        required: true
      app_private_key:
        description: 'GitHub App private key for authentication'
        required: true
      slack_webhook_url:
        description: 'Slack incoming webhook URL for release announcements'
        required: false
      mastodon_access_token:
        description: 'Mastodon bot access token'
        required: false
      mastodon_instance:
        description: 'Mastodon instance URL (e.g., https://ruby.social)'
        required: false
      bluesky_identifier:
        description: 'Bluesky handle or DID'
        required: false
      bluesky_password:
        description: 'Bluesky app password'
        required: false

jobs:
  bump-dev-version:
    if: ${{ inputs.target_branch == 'main' }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          ref: main

      - name: Calculate next dev version
        id: version
        run: |
          # Read current version
          CURRENT=$(grep VERSION "${{ inputs.version_file_path }}" | sed 's/.*"\(.*\)".*/\1/')
          echo "Current version: $CURRENT"

          # Strip any pre-release suffix to get base version
          BASE_VERSION=$(echo "$CURRENT" | sed 's/\.[a-zA-Z][a-zA-Z0-9]*$//')
          echo "Base version: $BASE_VERSION"

          # Split into major.minor.patch and bump minor
          IFS='.' read -r MAJOR MINOR _ <<< "$BASE_VERSION"
          MINOR=$((MINOR + 1))
          NEW_VERSION="$MAJOR.$MINOR.0.dev"

          echo "New dev version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Configure git
        run: |
          git config user.name "alchemycms-bot"
          git config user.email "alchemycms-bot@users.noreply.github.com"

      - name: Bump to dev version
        run: |
          sed -i 's/VERSION = "[^"]*"/VERSION = "${{ steps.version.outputs.version }}"/' ${{ inputs.version_file_path }}

      - name: Create branch, commit and open PR
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          BRANCH="post-release/${{ steps.version.outputs.version }}"
          git checkout -b "$BRANCH"
          git add ${{ inputs.version_file_path }}
          git commit -m "Start development of version ${{ steps.version.outputs.version }}"
          git push origin "$BRANCH"

          gh pr create \
            --base "main" \
            --head "$BRANCH" \
            --title "Start development of version ${{ steps.version.outputs.version }}" \
            --body "Automated version bump after release.

          This PR was automatically created by the post-release workflow." \
            --label "skip-changelog"

  sync-changelog-to-main:
    if: ${{ inputs.target_branch != 'main' && contains(inputs.target_branch, '-stable') }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.app_id }}
          private-key: ${{ secrets.app_private_key }}

      - uses: actions/checkout@v4
        with:
          token: ${{ steps.generate-token.outputs.token }}
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: Get released version
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Extract changelog entry from stable branch
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # Fetch latest from stable branch to ensure we have the merged changelog
          git fetch origin "${{ inputs.target_branch }}"
          git checkout "origin/${{ inputs.target_branch }}" -- CHANGELOG.md

          # Extract the changelog section for this version
          awk -v ver="$VERSION" '
            /^## / {
              if (found) exit
              if (index($0, ver)) found=1
            }
            found { print }
          ' CHANGELOG.md > /tmp/changelog-entry.md

          echo "Extracted changelog entry:"
          cat /tmp/changelog-entry.md

      - name: Configure git
        run: |
          git config user.name "alchemycms-bot"
          git config user.email "alchemycms-bot@users.noreply.github.com"

      - name: Update changelog on main and open PR
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          # Fetch and checkout main
          git fetch origin main
          git checkout main

          VERSION="${{ steps.version.outputs.version }}"

          # Check if this version already exists in main's changelog
          if grep -q "^## $VERSION" CHANGELOG.md; then
            echo "Version $VERSION already in main changelog, skipping"
            exit 0
          fi

          # Insert the changelog entry after the first line (# Changelog header)
          # and any blank lines following it
          {
            head -n 1 CHANGELOG.md
            echo ""
            cat /tmp/changelog-entry.md
            tail -n +2 CHANGELOG.md
          } > /tmp/changelog-new.md
          mv /tmp/changelog-new.md CHANGELOG.md

          # Create branch and commit
          BRANCH="changelog/$VERSION"
          git checkout -b "$BRANCH"
          git add CHANGELOG.md
          git commit -m "Add $VERSION changelog entry from stable branch"
          git push origin "$BRANCH"

          # Create PR with label
          gh pr create \
            --base "main" \
            --head "$BRANCH" \
            --title "Add $VERSION changelog entry from stable branch" \
            --body "Syncs changelog entry from stable branch release to main.

          This ensures tools like Dependabot can see the changelog for this release.

          This PR was automatically created by the post-release workflow." \
            --label "skip-changelog"

  announce:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.slack_webhook_url }}
      MASTODON_ACCESS_TOKEN: ${{ secrets.mastodon_access_token }}
      MASTODON_INSTANCE: ${{ secrets.mastodon_instance }}
      BLUESKY_IDENTIFIER: ${{ secrets.bluesky_identifier }}
      BLUESKY_PASSWORD: ${{ secrets.bluesky_password }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.target_branch }}
          fetch-depth: 0

      - name: Get latest release version
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0 | sed 's/^v//')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Post to Slack
        if: ${{ env.SLACK_WEBHOOK_URL != '' }}
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ env.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ðŸŽ‰ *${{ inputs.gem_name || github.event.repository.name }} v${{ steps.version.outputs.version }}* has been released!\n\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}|View release notes>"
                  }
                }
              ]
            }

      - name: Post to Mastodon
        if: ${{ env.MASTODON_ACCESS_TOKEN != '' && env.MASTODON_INSTANCE != '' }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $MASTODON_ACCESS_TOKEN" \
            -F "status=ðŸŽ‰ ${{ inputs.gem_name || github.event.repository.name }} v${{ steps.version.outputs.version }} has been released!

          ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}

          #RubyGems #Ruby #Rails #CMS #AlchemyCMS" \
            "$MASTODON_INSTANCE/api/v1/statuses"

      - name: Post to Bluesky
        if: ${{ env.BLUESKY_IDENTIFIER != '' && env.BLUESKY_PASSWORD != '' }}
        uses: cbrgm/bluesky-github-action@v1
        with:
          handle: ${{ env.BLUESKY_IDENTIFIER }}
          password: ${{ env.BLUESKY_PASSWORD }}
          text: |
            ðŸŽ‰ ${{ inputs.gem_name || github.event.repository.name }} v${{ steps.version.outputs.version }} has been released!

            ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}

            #rubygems #ruby #rails #cms #alchemycms
